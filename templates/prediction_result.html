<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction Results</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.min.css">
    
    <link rel="stylesheet" href="/assets/css/base.css">
</head>
<body>

<!-- HEADER -->
<header class="app-header">
    <h1 class="app-title">ðŸ“Š Prediction Results</h1>
    <div class="breadcrumb" id="breadcrumb"></div>
</header>

<!-- MAIN CONTENT -->
<main class="results-container">
    
    <!-- Main Prediction Display -->
    <div class="prediction-display">
        <div class="prediction-label">Predicted Length of Stay</div>
        
        <!-- Primary Display -->
        <div class="prediction-value" id="predicted-los">--</div>
        
        <!-- Format Toggle -->
        <div class="prediction-secondary">
            <button 
                id="toggle-format" 
                class="btn btn-secondary"
                style="
                    margin-top: var(--space-md);
                    padding: var(--space-sm) var(--space-md);
                    font-size: var(--font-size-sm);
                "
            >
                Show as Hours
            </button>
            <div id="alternate-format" style="margin-top: var(--space-sm); font-size: var(--font-size-sm); opacity: 0.9;"></div>
        </div>
        
        <div class="confidence-bar">
            <div style="font-size: var(--font-size-sm); opacity: 0.9;">
                95% Confidence Interval
            </div>
            <div class="confidence-range">
                <span id="confidence-low">--</span>
                <span>to</span>
                <span id="confidence-high">--</span>
            </div>
        </div>
    </div>
    
    <!-- Hospital Context -->
    <div class="result-card">
        <h2 style="margin-bottom: var(--space-lg);">
            <i class="lucide lucide-hospital" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px; vertical-align: middle;"></i>
            Hospital Context
        </h2>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-item-label">Hospital</div>
                <div class="info-item-value" id="display-hospital">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">County</div>
                <div class="info-item-value" id="display-county">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Hospital Average LOS</div>
                <div class="info-item-value" id="hospital-avg">4.2 days</div>
            </div>
        </div>
    </div>
    
    <!-- Patient Factors -->
    <div class="result-card">
        <h2 style="margin-bottom: var(--space-lg);">
            <i class="lucide lucide-user" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px; vertical-align: middle;"></i>
            Patient Information
        </h2>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-item-label">Age Group</div>
                <div class="info-item-value" id="display-age">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Gender</div>
                <div class="info-item-value" id="display-gender">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Race</div>
                <div class="info-item-value" id="display-race">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Ethnicity</div>
                <div class="info-item-value" id="display-ethnicity">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Insurance</div>
                <div class="info-item-value" id="display-insurance">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Admission Type</div>
                <div class="info-item-value" id="display-admission">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Diagnosis Group</div>
                <div class="info-item-value" id="display-diagnosis">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Medical/Surgical</div>
                <div class="info-item-value" id="display-medsurg">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Emergency Dept</div>
                <div class="info-item-value" id="display-emergency">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Severity</div>
                <div class="info-item-value" id="display-severity">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Comorbidities</div>
                <div class="info-item-value" id="display-comorbidity">--</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Patient Disposition</div>
                <div class="info-item-value" id="display-disposition">--</div>
            </div>
        </div>
    </div>
    
    <!-- Risk Factors -->
    <div class="result-card">
        <h2 style="margin-bottom: var(--space-lg);">
            <i class="lucide lucide-alert-triangle" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px; vertical-align: middle;"></i>
            Contributing Factors
        </h2>
        <ul class="risk-factors" id="risk-factors">
            <!-- Populated by JavaScript -->
        </ul>
    </div>
    
    <!-- Actions -->
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="window.print()">
            <i class="lucide lucide-printer" style="width: 18px; height: 18px;"></i>
            Print Report
        </button>
        <button class="btn btn-secondary" onclick="newPrediction()">
            <i class="lucide lucide-plus-circle" style="width: 18px; height: 18px;"></i>
            New Prediction
        </button>
        <button class="btn btn-secondary" onclick="history.back()">
            <i class="lucide lucide-arrow-left" style="width: 18px; height: 18px;"></i>
            Back to Form
        </button>
    </div>
    
</main>

<!-- Scripts -->
<script src="/assets/js/stateManager.js"></script>

<script>
    // =============================================
    // LOAD PREDICTION DATA FROM CACHE
    // =============================================
    
    console.log('Results page loaded');
    
    const cachedData = StateManager.getCachedPrediction();
    
    console.log('Cached data:', cachedData);
    
    if (!cachedData) {
        console.error('No cached data found!');
        StateManager.showError(
            'No prediction data found. Please complete the form first.',
            '/'
        );
        throw new Error('No prediction data');
    }
    
    if (!cachedData.result) {
        console.error('Cached data exists but no result:', cachedData);
        StateManager.showError(
            'Prediction result is missing. Please try submitting the form again.',
            '/page/prediction_form'
        );
        throw new Error('No prediction result');
    }
    
    const inputData = cachedData.input;   // Original form submission
    const apiResult = cachedData.result;  // API response
    
    console.log('Input data:', inputData);
    console.log('API result:', apiResult);
    
    // =============================================
    // UPDATE BREADCRUMBS
    // =============================================
    
    StateManager.renderBreadcrumbs();
    
    // =============================================
    // FORMAT TOGGLE FUNCTIONALITY
    // =============================================

    let currentFormat = 'auto';
    const formatOptions = ['auto', 'hours', 'days-hours', 'days-only'];
    const formatLabels = {
        'auto': 'Show as Hours',
        'hours': 'Show as Days+Hours',
        'days-hours': 'Show Days Only',
        'days-only': 'Show Auto Format'
    };

    document.getElementById('toggle-format').addEventListener('click', () => {
        // Cycle through formats
        const currentIndex = formatOptions.indexOf(currentFormat);
        currentFormat = formatOptions[(currentIndex + 1) % formatOptions.length];
        
        // Update display
        const newFormatted = TimeFormatter.formatLOS(apiResult.predicted_los, currentFormat);
        document.getElementById('predicted-los').textContent = newFormatted;
        
        const newConfidence = TimeFormatter.formatConfidenceInterval(
            apiResult.confidence_interval, 
            currentFormat
        );
        document.getElementById('confidence-low').textContent = newConfidence.low;
        document.getElementById('confidence-high').textContent = newConfidence.high;
        
        // Update button label
        document.getElementById('toggle-format').textContent = formatLabels[currentFormat];
        
        // Show alternate format
        const allFormats = TimeFormatter.getFormattedOptions(apiResult.predicted_los);
        const alternates = Object.entries(allFormats)
            .filter(([key]) => key !== currentFormat && key !== 'raw')
            .map(([key, val]) => val)
            .join(' â€¢ ');
        
        document.getElementById('alternate-format').textContent = alternates;
    });
    
    // =============================================
    // DISPLAY PREDICTION RESULTS
    // =============================================

    // Get formatted time values
    const losFormatted = TimeFormatter.formatLOS(apiResult.predicted_los, 'auto');
    const confidenceFormatted = TimeFormatter.formatConfidenceInterval(
        apiResult.confidence_interval, 
        'auto'
    );

    // Main prediction value - PRIMARY DISPLAY
    document.getElementById('predicted-los').textContent = losFormatted;

    // Confidence interval
    document.getElementById('confidence-low').textContent = confidenceFormatted.low;
    document.getElementById('confidence-high').textContent = confidenceFormatted.high;
    
    // =============================================
    // DISPLAY HOSPITAL CONTEXT
    // =============================================
    
    const hospitalName = apiResult.metadata?.hospital_name || inputData.hospital_name || inputData['Facility Name'] || '--';
    const countyName = apiResult.metadata?.county_name || inputData.county_name || inputData['Hospital County'] || '--';
    
    console.log('Displaying hospital:', hospitalName);
    console.log('Displaying county:', countyName);
    
    document.getElementById('display-hospital').textContent = hospitalName;
    document.getElementById('display-county').textContent = countyName;
    
    // =============================================
    // DISPLAY PATIENT INFORMATION
    // =============================================
    
    document.getElementById('display-age').textContent = inputData['Age Group'] || '--';
    document.getElementById('display-gender').textContent = inputData['Gender'] || '--';
    document.getElementById('display-race').textContent = inputData['Race'] || '--';
    document.getElementById('display-ethnicity').textContent = inputData['Ethnicity'] || '--';
    document.getElementById('display-insurance').textContent = inputData['Payment Typology 1'] || '--';
    document.getElementById('display-admission').textContent = inputData['Type of Admission'] || '--';
    document.getElementById('display-diagnosis').textContent = inputData['APR MDC Description'] || '--';
    document.getElementById('display-medsurg').textContent = inputData['APR Medical Surgical Description'] || '--';
    document.getElementById('display-emergency').textContent = 
        inputData['Emergency Department Indicator'] === 'Y' ? 'Yes' : 
        (inputData['Emergency Department Indicator'] === 'N' ? 'No' : '--');
    document.getElementById('display-severity').textContent = 
        inputData['APR Severity of Illness Code'] ? 
        `Level ${inputData['APR Severity of Illness Code']}` : '--';
    document.getElementById('display-comorbidity').textContent = 
        inputData.comorbidity_count || 'None reported';
    document.getElementById('display-disposition').textContent = 
        inputData['Patient Disposition'] || '--';
    
    // =============================================
    // DISPLAY RISK FACTORS FROM API
    // =============================================
    
    const riskList = document.getElementById('risk-factors');
    riskList.innerHTML = ''; // Clear existing
    
    if (apiResult.risk_factors && apiResult.risk_factors.length > 0) {
        apiResult.risk_factors.forEach(factor => {
            const li = document.createElement('li');
            li.className = 'risk-factor';
            
            // Handle structured risk factor objects
            if (typeof factor === 'object' && factor.factor) {
                const impactColor = {
                    'high': '#e53e3e',
                    'medium': '#ed8936',
                    'low': '#48bb78',
                    'none': '#718096'
                }[factor.impact] || '#718096';
                
                li.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">
                        ${factor.factor}
                        <span style="
                            float: right; 
                            font-size: 12px; 
                            color: ${impactColor};
                            font-weight: 700;
                        ">
                            ${factor.impact_days || ''}
                        </span>
                    </div>
                    <div style="font-size: 14px; color: #718096;">
                        ${factor.description || ''}
                    </div>
                `;
            } else {
                // Fallback for simple string factors
                li.textContent = typeof factor === 'string' ? factor : JSON.stringify(factor);
            }
            
            riskList.appendChild(li);
        });
    } else {
        riskList.innerHTML = '<li class="risk-factor">No specific risk factors identified</li>';
    }
    
    // =============================================
    // ACTION HANDLERS
    // =============================================
    
    function newPrediction() {
        // Clear cache
        sessionStorage.removeItem('prediction_cache');
        
        // Navigate back to county selection
        window.location.href = '/';
    }
    
    console.log('Results page fully loaded and rendered');
</script>

</body>
</html>
