<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOS Prediction Form</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/assets/css/base.css">
</head>
<body>

<!-- HEADER -->
<header class="app-header">
    <h1 class="app-title">ðŸ“Š Length of Stay Prediction</h1>
    <div class="breadcrumb" id="breadcrumb"></div>
</header>

<!-- MAIN CONTENT -->
<main class="form-container">
    
    <!-- Back navigation -->
    <a href="#" onclick="history.back(); return false;" class="back-button">
        <i class="lucide lucide-arrow-left" style="width: 16px; height: 16px;"></i>
        <span>Back to Hospital Selection</span>
    </a>
    
    <!-- Hospital Context Card -->
    <div class="hospital-info">
        <div class="hospital-context-header">
            <div class="hospital-context-icon">
                <i class="lucide lucide-hospital" style="width: 32px; height: 32px; color: white;"></i>
            </div>
            <div>
                <h2 class="hospital-context-title">Prediction Context</h2>
                <p class="hospital-context-subtitle">Enter patient information for LOS prediction</p>
            </div>
        </div>
        
        <div class="context-details">
            <div class="context-item">
                <div class="context-label">Hospital</div>
                <div class="context-value" id="hospital-name">--</div>
            </div>
            <div class="context-item">
                <div class="context-label">County</div>
                <div class="context-value" id="county-name">--</div>
            </div>
            <div class="context-item">
                <div class="context-label">Hospital ID</div>
                <div class="context-value" id="hospital-id">--</div>
            </div>
        </div>
    </div>
    
    <!-- Progress Indicator -->
    <div class="form-progress">
        <div class="progress-step completed">
            <div class="progress-dot">âœ“</div>
            <span>County</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step completed">
            <div class="progress-dot">âœ“</div>
            <span>Hospital</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step active">
            <div class="progress-dot">3</div>
            <span>Patient Info</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step">
            <div class="progress-dot">4</div>
            <span>Results</span>
        </div>
    </div>
    
    <!-- Prediction Form -->
    <form id="prediction-form">
        
        <!-- Section 1: Demographics -->
        <div class="form-section">
            <h3 class="form-section-title">
                <i class="lucide lucide-user" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px; vertical-align: middle;"></i>
                Patient Demographics
            </h3>
            
            <div class="form-grid">
                <div class="form-field">
                    <label for="age_group" class="form-label required">Age Group</label>
                    <select id="age_group" name="age_group" class="form-select">
                        <option value="">Select age range</option>
                        <option value="0 to 17">0 to 17 years</option>
                        <option value="18 to 29">18 to 29 years</option>
                        <option value="30 to 49">30 to 49 years</option>
                        <option value="50 to 69">50 to 69 years</option>
                        <option value="70 or Older">70 or Older years</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="gender" class="form-label required">Gender</label>
                    <select id="gender" name="gender" class="form-select">
                        <option value="">Select gender</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="race" class="form-label required">Race</label>
                    <select id="race" name="race" class="form-select">
                        <option value="">Select race</option>
                        <option value="Black/African American">Black/African American</option>
                        <option value="Multi-racial">Multi-racial</option>
                        <option value="White">White</option>
                        <option value="Other Race">Other Race</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="ethnicity" class="form-label required">Ethnicity</label>
                    <select id="ethnicity" name="ethnicity" class="form-select">
                        <option value="">Select ethnicity</option>
                        <option value="Multi-ethnic">Multi-ethnic</option>
                        <option value="Spanish/Hispanic">Spanish/Hispanic</option>
                        <option value="Not Span/Hispanic">Not Spanish/Hispanic</option>
                        <option value="Unknown">Unknown</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="insurance_type" class="form-label required">Insurance Type</label>
                    <select id="insurance_type" name="insurance_type" class="form-select">
                        <option value="">Select insurance</option>
                        <option value="Medicare">Medicare</option>
                        <option value="Medicaid">Medicaid</option>
                        <option value="Private Health Insurance">Private Health Insurance</option>
                        <option value="Self-Pay">Self-Pay</option>
                        <option value="Blue Cross/Blue Shield">Blue Cross/Blue Shield</option>
                        <option value="Department of Corrections">Department of Corrections</option>
                        <option value="Federal/State/Local/VA">Federal/State/Local/VA</option>
                        <option value="Managed Care, Unspecified">Managed Care, Unspecified</option>
                        <option value="Miscellaneous/Other">Miscellaneous/Other</option>
                        <option value="Unknown">Unknown</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Section 2: Clinical Information -->
        <div class="form-section">
            <h3 class="form-section-title">
                <i class="lucide lucide-activity" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px; vertical-align: middle;"></i>
                Clinical Information
            </h3>
            
            <div class="form-grid">
                <div class="form-field">
                    <label for="admission_type" class="form-label required">Admission Type</label>
                    <select id="admission_type" name="admission_type" class="form-select">
                        <option value="">Select admission type</option>
                        <option value="Emergency">Emergency</option>
                        <option value="Urgent">Urgent</option>
                        <option value="Elective">Elective/Scheduled</option>
                        <option value="Newborn">Newborn</option>
                        <option value="Trauma">Trauma</option>
                        <option value="Not Available">Not Available</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="patient_disposition" class="form-label required">Patient Disposition</label>
                    <select id="patient_disposition" name="patient_disposition" class="form-select">
                        <option value="">Select patient disposition</option>
                        <option value="Home or Self Care">Home or Self Care</option>
                        <option value="Home w/ Home Health Services">Home w/ Home Health Services</option>
                        <option value="Short-term Hospital">Short-term Hospital</option>
                        <option value="Skilled Nursing Home">Skilled Nursing Home</option>
                        <option value="Inpatient Rehabilitation Facility">Inpatient Rehabilitation Facility</option>
                        <option value="Hospice - Home">Hospice - Home</option>
                        <option value="Hospice - Medical Facility">Hospice - Medical Facility</option>
                        <option value="Expired">Expired</option>
                        <option value="Left Against Medical Advice">Left Against Medical Advice</option>
                        <option value="Medicaid Cert Nursing Facility">Medicaid Cert Nursing Facility</option>
                        <option value="Medicare Cert Long Term Care Hospital">Medicare Cert Long Term Care Hospital</option>
                        <option value="Psychiatric Hospital or Unit of Hosp">Psychiatric Hospital or Unit of Hosp</option>
                        <option value="Critical Access Hospital">Critical Access Hospital</option>
                        <option value="Cancer Center or Children's Hospital">Cancer Center or Children's Hospital</option>
                        <option value="Another Type Not Listed">Another Type Not Listed</option>
                        <option value="Federal Health Care Facility">Federal Health Care Facility</option>
                        <option value="Facility w/ Custodial/Supportive Care">Facility w/ Custodial/Supportive Care</option>
                        <option value="Hosp Basd Medicare Approved Swing Bed">Hosp Basd Medicare Approved Swing Bed</option>
                        <option value="Court/Law Enforcement">Court/Law Enforcement</option>
                        <option value="Admitted from Ambulatory Surgery">Admitted from Ambulatory Surgery</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="diagnosis_group" class="form-label required">Primary Diagnosis Group</label>
                    <select id="diagnosis_group" name="diagnosis_group" class="form-select">
                        <option value="">Select diagnosis</option>
                        <option value="Pre-MDC or Ungroupable">Pre-MDC or Ungroupable</option>
                        <option value="Human Immunodeficiency Virus Infections">Human Immunodeficiency Virus Infections</option>
                        <option value="Diseases and Disorders of the Circulatory System">Circulatory System</option>
                        <option value="Pregnancy, Childbirth and the Puerperium">Pregnancy & Childbirth</option>
                        <option value="Newborns and Other Neonates with Conditions Originating in the Perinatal Period">Newborns & Neonates</option>
                        <option value="Diseases and Disorders of the Musculoskeletal System and Conn Tissue">Musculoskeletal System</option>
                        <option value="Diseases and Disorders of the Respiratory System">Respiratory System</option>
                        <option value="Diseases and Disorders of the Digestive System">Digestive System</option>
                        <option value="Diseases and Disorders of the Nervous System">Nervous System</option>
                        <option value="Infectious and Parasitic Diseases, Systemic or Unspecified Sites">Infectious Diseases</option>
                        <option value="Diseases and Disorders of the Kidney and Urinary Tract">Kidney & Urinary Tract</option>
                        <option value="Mental Diseases and Disorders">Mental Diseases</option>
                        <option value="Endocrine, Nutritional and Metabolic Diseases and Disorders">Endocrine & Metabolic</option>
                        <option value="Alcohol/Drug Use and Alcohol/Drug Induced Organic Mental Disorders">Alcohol/Drug Use</option>
                        <option value="Diseases and Disorders of the Hepatobiliary System and Pancreas">Hepatobiliary & Pancreas</option>
                        <option value="Diseases and Disorders of the Skin, Subcutaneous Tissue and Breast">Skin & Breast</option>
                        <option value="Diseases and Disorders of Blood, Blood Forming Organs and Immunological Disorders">Blood & Immunological</option>
                        <option value="Ear, Nose, Mouth, Throat and Craniofacial Diseases and Disorders">ENT & Craniofacial</option>
                        <option value="Rehabilitation, Aftercare, Other Factors Influencing Health Status and Other Health Service Contacts">Rehabilitation & Aftercare</option>
                        <option value="Poisonings, Toxic Effects, Other Injuries and Other Complications of Treatment">Poisonings & Injuries</option>
                        <option value="Diseases and Disorders of the Female Reproductive System">Female Reproductive</option>
                        <option value="Lymphatic, Hematopoietic, Other Malignancies, Chemotherapy and Radiotherapy">Malignancies & Chemotherapy</option>
                        <option value="Diseases and Disorders of the Male Reproductive System">Male Reproductive</option>
                        <option value="Multiple Significant Trauma">Multiple Trauma</option>
                        <option value="Diseases and Disorders of the Eye">Eye Disorders</option>
                        <option value="Burns">Burns</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="medical/surgical" class="form-label required">Medical/Surgical</label>
                    <select id="medical/surgical" name="medical/surgical" class="form-select">
                        <option value="">Select type</option>
                        <option value="Medical">Medical</option>
                        <option value="Surgical">Surgical</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="is_emergency" class="form-label required">Emergency Department Indicator</label>
                    <select id="is_emergency" name="is_emergency" class="form-select">
                        <option value="">Was patient in ED?</option>
                        <option value="Y">Yes</option>
                        <option value="N">No</option>
                    </select>
                    <span class="form-help">Patient admitted through Emergency Department</span>
                </div>
                
                <div class="form-field">
                    <label for="severity" class="form-label required">Severity Level</label>
                    <select id="severity" name="severity" class="form-select">
                        <option value="">Select severity</option>
                        <option value="1">Minor (Level 1)</option>
                        <option value="2">Moderate (Level 2)</option>
                        <option value="3">Severe (Level 3)</option>
                        <option value="4">Critical (Level 4)</option>
                    </select>
                    <span class="form-help">Based on clinical assessment</span>
                </div>
            </div>
        </div>
        
        <!-- Section 3: Additional Factors (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">
                <i class="lucide lucide-clipboard-list" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px; vertical-align: middle;"></i>
                Additional Factors (Optional)
            </h3>
            
            <div class="form-grid">
                <div class="form-field">
                    <label for="comorbidity_count" class="form-label">Number of Comorbidities</label>
                    <input 
                        type="number" 
                        id="comorbidity_count" 
                        name="comorbidity_count"
                        class="form-input"
                        min="0" 
                        max="10"
                        placeholder="0"
                    />
                    <span class="form-help">Count of chronic conditions (0-10)</span>
                </div>
                
                <div class="form-field">
                    <label for="prior_admissions" class="form-label">Prior Admissions (90 days)</label>
                    <input 
                        type="number" 
                        id="prior_admissions" 
                        name="prior_admissions"
                        class="form-input"
                        min="0" 
                        max="50"
                        placeholder="0"
                    />
                    <span class="form-help">Hospital visits in last 3 months</span>
                </div>
            </div>
        </div>
        
        <!-- Submit Button -->
        <div class="submit-section">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="lucide lucide-calculator" style="width: 20px; height: 20px;"></i>
                <span>Calculate Predicted Length of Stay</span>
                <i class="lucide lucide-arrow-right" style="width: 20px; height: 20px;"></i>
            </button>
            <p class="submit-hint">All required fields must be completed before prediction</p>
        </div>
        
    </form>
    
</main>

<!-- Scripts -->
<script src="/assets/js/stateManager.js"></script>
<script src="/assets/js/validation.js"></script>

<script>
    // =============================================
    // VALIDATE REQUIRED STATE
    // =============================================
    
    if (!StateManager.validateRequired(['hospital_id', 'hospital_name', 'county_name'])) {
        throw new Error('Missing required parameters');
    }
    
    const hospitalId = StateManager.getParam('hospital_id');
    const hospitalName = StateManager.getParam('hospital_name');
    const countyName = StateManager.getParam('county_name');
    const countyId = StateManager.getParam('county_id');
    
    console.log('Page loaded with params:', { hospitalId, hospitalName, countyName, countyId });
    
    // =============================================
    // UPDATE PAGE CONTENT
    // =============================================
    
    document.getElementById('hospital-name').textContent = hospitalName || '--';
    document.getElementById('county-name').textContent = countyName || '--';
    document.getElementById('hospital-id').textContent = hospitalId || '--';
    
    StateManager.renderBreadcrumbs();
    
    // =============================================
    // ATTACH VALIDATION
    // =============================================
    
    Validator.attachLiveValidation('prediction-form');
    
    // =============================================
    // FORM SUBMISSION - SINGLE UNIFIED HANDLER
    // =============================================
    
    document.getElementById('prediction-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        console.log('Form submitted');
        
        // Clear previous errors
        Validator.clearAllErrors();
        
        // Get form data
        const formData = Validator.getFormData('prediction-form');
        console.log('Form data:', formData);
        
        // Validate
        const validation = Validator.validateForm(formData);
        
        if (!validation.valid) {
            console.log('Validation failed:', validation.errors);
            
            // Show errors
            Object.keys(validation.errors).forEach(fieldName => {
                Validator.showFieldError(fieldName, validation.errors[fieldName]);
            });
            
            // Scroll to first error
            const firstError = document.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            return;
        }
        
        // Build prediction payload
        const payload = Validator.buildPredictionPayload(formData, {
            hospital_id: hospitalId,
            hospital_name: hospitalName,
            county_name: countyName,
            county_id: countyId
        });
        
        console.log('Sending prediction request:', payload);
        
        // Show loading state
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalHTML = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner"></div><span>Calculating...</span>';
        
        try {
            // Call the prediction API - FIXED ENDPOINT
            const response = await fetch('/api/predict', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `API Error: ${response.status}`);
            }
            
            const predictionResult = await response.json();
            
            console.log('Prediction received:', predictionResult);
            
            // Cache BOTH input data AND prediction results
            StateManager.cachePredictionData({
                input: payload,
                result: predictionResult
            });
            
            // Navigate to results
            StateManager.navigate('/page/prediction_result', {
                hospital_id: hospitalId,
                hospital_name: hospitalName,
                county_name: countyName,
                county_id: countyId
            });
            
        } catch (error) {
            console.error('Prediction failed:', error);
            
            // Show user-friendly error
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.marginBottom = 'var(--space-xl)';
            errorDiv.innerHTML = `
                <div class="error-title">Prediction Failed</div>
                <p>Unable to get prediction. Please try again.</p>
                <p style="font-size: var(--font-size-sm); margin-top: var(--space-sm);">
                    <strong>Error:</strong> ${error.message}
                </p>
                <p style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-top: var(--space-sm);">
                    If this persists, please check that the backend server is running and the /api/predict endpoint is available.
                </p>
            `;
            
            // Remove any existing error messages
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Add new error at top of form container
            const formContainer = document.querySelector('.form-container');
            const firstChild = formContainer.firstElementChild;
            formContainer.insertBefore(errorDiv, firstChild.nextSibling);
            
            // Scroll to error
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Restore button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHTML;
        }
    });
</script>

</body>
</html>
